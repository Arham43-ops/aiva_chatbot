{% extends 'chatbot/admin_base.html' %}

{% block title %}Admin Dashboard - Knowledge Base{% endblock %}

{% block header_title %}Knowledge Base Management{% endblock %}

{% block content %}
<!-- Knowledge Base Section -->
<section id="knowledge-base" class="admin-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="section-title mb-0">Knowledge Base Entries</h2>
        <div>
            <button class="btn btn-primary me-2" onclick="showAddEntryModal()">
                <i class="fas fa-plus"></i> Add New Entry
            </button>
            <button class="btn btn-outline-primary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    {% if knowledge_base_entries %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Question</th>
                    <th>Answer</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in knowledge_base_entries %}
                <tr>
                    <td>{{ entry.question|truncatechars:100 }}</td>
                    <td>{{ entry.answer|truncatechars:100 }}</td>
                    <td>{{ entry.created_at|date:"M d, Y H:i" }}</td>
                    <td>{{ entry.updated_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="editEntry({{ entry.id }})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEntry({{ entry.id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-book"></i>
        <p>No knowledge base entries found. Add your first entry!</p>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block modals %}
<!-- Add/Edit Entry Modal -->
<div class="modal fade" id="entryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="entryForm">
                    {% csrf_token %}
                    <input type="hidden" id="entryId" name="entry_id">
                    <div class="mb-3">
                        <label for="question" class="form-label">Question</label>
                        <textarea class="form-control" id="question" name="question" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="answer" class="form-label">Answer</label>
                        <textarea class="form-control" id="answer" name="answer" rows="5" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .admin-section {
        background: var(--card-bg);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
        text-shadow: 0 0 10px rgba(0, 234, 255, 0.2);
    }

    .table {
        color: var(--text-color);
    }

    .table thead th {
        border-bottom: 2px solid var(--border-color);
        color: var(--primary-color);
    }

    .table td {
        vertical-align: middle;
    }

    .btn-group {
        gap: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-color);
        opacity: 0.7;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--primary-color);
    }

    .modal-content {
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
    }

    .form-control {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-color);
    }

    .form-control:focus {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--primary-color);
        color: var(--text-color);
        box-shadow: 0 0 0 0.25rem rgba(0, 234, 255, 0.25);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let entryModal;

    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('entryModal');
        entryModal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: false
        });

        modalElement.addEventListener('hidden.bs.modal', function () {
            document.getElementById('entryForm').reset();
        });
    });

    function showAddEntryModal() {
        document.getElementById('modalTitle').textContent = 'Add New Entry';
        document.getElementById('entryId').value = '';
        document.getElementById('question').value = '';
        document.getElementById('answer').value = '';
        
        const modalElement = document.getElementById('entryModal');
        const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
        modal.show();
    }

    function editEntry(entryId) {
        document.getElementById('modalTitle').textContent = 'Edit Entry';
        document.getElementById('entryId').value = entryId;
        
        fetch(`/chatbot/admin/knowledge-base/${entryId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('question').value = data.question;
                document.getElementById('answer').value = data.answer;
                
                const modalElement = document.getElementById('entryModal');
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load entry data: ' + error.message);
            });
    }

    function saveEntry() {
        const entryId = document.getElementById('entryId').value;
        const question = document.getElementById('question').value.trim();
        const answer = document.getElementById('answer').value.trim();
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        if (!question || !answer) {
            alert('Please fill in both question and answer fields.');
            return;
        }

        const url = entryId ? 
            `/chatbot/admin/knowledge-base/${entryId}/update/` : 
            '/chatbot/admin/knowledge-base/add/';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                question: question,
                answer: answer
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const modalElement = document.getElementById('entryModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                location.reload();
            } else {
                throw new Error(data.message || 'Failed to save entry');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });
    }

    function deleteEntry(entryId) {
        if (confirm('Are you sure you want to delete this entry?')) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/chatbot/admin/knowledge-base/${entryId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    throw new Error(data.message || 'Failed to delete entry');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        }
    }
</script>
{% endblock %}